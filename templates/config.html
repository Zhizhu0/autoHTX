<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系统参数设置</title>
    <style>
        :root {
            --bg-body: #f9f9f9;
            --bg-card: #ffffff;
            --text-main: #333;
            --text-sub: #666;
            --border: #ddd;
            --input-bg: #fff;
            --link-color: #007bff;
            --slider-bg: #ccc;
            --slider-on: #2196F3;
            --toast-bg: #333;
            --toast-text: #fff;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-body: #121212;
                --bg-card: #1e1e1e;
                --text-main: #e0e0e0;
                --text-sub: #aaa;
                --border: #444;
                --input-bg: #2c2c2c;
                --link-color: #4dabf7;
                --slider-bg: #555;
                --slider-on: #0d6efd;
                --toast-bg: #eee;
                --toast-text: #000;
            }
        }

        body {
            font-family: "Microsoft YaHei", sans-serif;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
            background-color: var(--bg-body);
            color: var(--text-main);
        }

        h2, h3 { color: var(--text-main); }

        .group {
            margin-bottom: 20px;
            background: var(--bg-card);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid var(--border);
        }

        label { display: block; margin-bottom: 8px; font-weight: bold; color: var(--text-main); }

        input[type="text"], input[type="password"], input[type="number"] {
            width: 100%;
            padding: 12px;
            box-sizing: border-box;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: var(--input-bg);
            color: var(--text-main);
            font-size: 16px;
        }

        input:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background: rgba(0,0,0,0.1);
        }

        .range-container { width: 100%; padding: 10px 0; }
        input[type=range] { width: 100%; -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: var(--slider-on); cursor: pointer; margin-top: -8px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: var(--border); border-radius: 2px; }
        .range-value { font-weight: bold; color: var(--link-color); margin-left: 10px; }
        .level-desc { font-size: 13px; color: var(--text-sub); background: rgba(0,0,0,0.05); padding: 8px; border-radius: 4px; margin-top: 5px; line-height: 1.5; }

        .back { margin-bottom: 20px; display: inline-block; text-decoration: none; color: var(--link-color); font-weight: bold; font-size: 16px; }

        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--slider-bg); transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--slider-on); }
        input:checked + .slider:before { transform: translateX(22px); }

        .row { display: flex; align-items: center; justify-content: space-between; }
        .desc { font-size: 13px; color: var(--text-sub); margin-top: 5px; line-height: 1.4; }
        .vol-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }

        /* Toast Notification */
        #toast {
            visibility: hidden;
            min-width: 200px;
            background-color: var(--toast-bg);
            color: var(--toast-text);
            text-align: center;
            border-radius: 4px;
            padding: 12px;
            position: fixed;
            z-index: 1;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
        }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }

        @media (max-width: 480px) {
            .vol-grid { grid-template-columns: repeat(2, 1fr); }
            body { padding: 15px; }
        }
    </style>
</head>
<body>
    <a href="/" class="back">← 返回主页</a>
    <h2>系统参数设置</h2>

    <!-- AI 配置 -->
    <div class="group">
        <h3>分析 AI 配置 (Analysis)</h3>
        <label>API URL</label>
        <input type="text" id="aiApiUrl" onchange="saveVal('aiApiUrl', this.value)">
        <div style="height:10px"></div>
        <label>Model</label>
        <input type="text" id="aiModel" onchange="saveVal('aiModel', this.value)">
    </div>

    <div class="group">
        <h3>聊天 AI 配置 (Chat)</h3>

        <div class="row">
            <label style="margin:0">与分析 AI 相同</label>
            <label class="switch">
                <input type="checkbox" id="useSameAi" onchange="toggleChatConfig(this.checked); saveCheck('useSameAi', this.checked)">
                <span class="slider"></span>
            </label>
        </div>
        <div class="desc">若开启，聊天将使用上方的分析 AI 配置。</div>

        <div id="chatConfigArea" style="margin-top: 15px;">
            <label>Chat API URL</label>
            <input type="text" id="chatApiUrl" onchange="saveVal('chatApiUrl', this.value)">
            <div style="height:10px"></div>
            <label>Chat Model</label>
            <input type="text" id="chatModel" onchange="saveVal('chatModel', this.value)">
        </div>

        <div style="height:15px; border-top: 1px solid var(--border); margin: 15px 0;"></div>

        <div class="row">
            <label style="margin:0">发送时立即请求 AI</label>
            <label class="switch">
                <input type="checkbox" id="chatTrigger" onchange="saveCheck('chatTrigger', this.checked)">
                <span class="slider"></span>
            </label>
        </div>
        <div class="desc">日志页点击“发送”时，是否自动触发聊天 AI 回复。</div>
    </div>

    <!-- 常规配置 -->
    <div class="group">
        <div class="row">
            <label style="margin:0">启用自动交易</label>
            <label class="switch">
                <input type="checkbox" id="systemStatus" onchange="saveCheck('systemStatus', this.checked)">
                <span class="slider"></span>
            </label>
        </div>
        <div class="desc">系统的全局总开关。</div>
    </div>

    <div class="group">
        <div class="row">
            <label style="margin:0">持仓时跳过</label>
            <label class="switch">
                <input type="checkbox" id="skipWhenHolding" onchange="saveCheck('skipWhenHolding', this.checked)">
                <span class="slider"></span>
            </label>
        </div>
        <div class="desc">如果当前有持仓，则跳过 AI 分析环节。</div>
    </div>

    <div class="group">
        <div class="row">
            <label style="margin:0">出错立即重试</label>
            <label class="switch">
                <input type="checkbox" id="ensureValidReq" onchange="saveCheck('ensureValidReq', this.checked)">
                <span class="slider"></span>
            </label>
        </div>
        <div class="desc">如果 AI 失败或格式无效，立即重试。</div>
    </div>

    <div class="group">
        <div class="row">
            <label style="margin:0">空结果视为无操作</label>
            <label class="switch">
                <input type="checkbox" id="emptyAsNone" onchange="saveCheck('emptyAsNone', this.checked)">
                <span class="slider"></span>
            </label>
        </div>
        <div class="desc">如果 AI 返回空字符串，视为“无操作”。</div>
    </div>

    <div class="group">
        <label>交易间隔 (分钟)</label>
        <input type="number" id="tradeInterval" min="1" onchange="saveVal('tradeInterval', this.value)">
    </div>

    <div class="group">
        <label>交易对 (Symbol)</label>
        <input type="text" id="tradeSymbol" onchange="saveVal('tradeSymbol', this.value)">
    </div>

    <div class="group">
        <label>杠杆倍数</label>
        <input type="number" id="tradeLeverage" onchange="saveVal('tradeLeverage', this.value)">
    </div>

    <div class="group">
        <label>策略激进级别 <span id="levelValue" class="range-value">2</span></label>
        <div class="range-container">
            <input type="range" id="aggressionLevel" min="0" max="4" step="1" oninput="updateLevelDesc(this.value)" onchange="saveVal('aggressionLevel', this.value)">
        </div>
        <div id="levelDesc" class="level-desc">加载中...</div>
    </div>

    <div class="group">
        <label>开仓数量 (张)</label>
        <div class="vol-grid">
            <div class="vol-item">
                <label style="font-size:12px">等级 0</label>
                <input type="number" id="volLevel0" onchange="saveVal('volLevel0', this.value)">
            </div>
            <div class="vol-item">
                <label style="font-size:12px">等级 1</label>
                <input type="number" id="volLevel1" onchange="saveVal('volLevel1', this.value)">
            </div>
            <div class="vol-item">
                <label style="font-size:12px">等级 2</label>
                <input type="number" id="volLevel2" onchange="saveVal('volLevel2', this.value)">
            </div>
            <div class="vol-item">
                <label style="font-size:12px">等级 3</label>
                <input type="number" id="volLevel3" onchange="saveVal('volLevel3', this.value)">
            </div>
        </div>
    </div>

    <h3>API 密钥设置</h3>
    <div class="group">
        <label>火币 Base URL</label>
        <input type="text" id="huobiUrl" onchange="saveVal('huobiUrl', this.value)">
    </div>
    <div class="group">
        <label>Gemini API Key</label>
        <input type="password" id="geminiKey" onchange="saveVal('geminiKey', this.value)">
    </div>
    <div class="group">
        <label>Access Key (火币)</label>
        <input type="password" id="accessKey" onchange="saveVal('accessKey', this.value)">
    </div>
    <div class="group">
        <label>Secret Key (火币)</label>
        <input type="password" id="secretKey" onchange="saveVal('secretKey', this.value)">
    </div>

    <div id="toast">已保存</div>

    <script>
        const map = {
            'geminiKey': 'getAIKey', 'accessKey': 'getAccessKey', 'secretKey': 'getSecretKey',
            'systemStatus': 'getSystemStatus', 'skipWhenHolding': 'getSkipHolding',
            'ensureValidReq': 'getEnsureValid', 'emptyAsNone': 'getEmptyAsNone',
            'tradeInterval': 'getInterval', 'tradeSymbol': 'getSymbol', 'tradeLeverage': 'getLeverage',
            'huobiUrl': 'getHuobiUrl',
            'aggressionLevel': 'getAggressionLevel',
            'volLevel0': 'getVol0', 'volLevel1': 'getVol1', 'volLevel2': 'getVol2', 'volLevel3': 'getVol3',
            // AI Configs
            'aiApiUrl': 'getAiApiUrl', 'aiModel': 'getAiModel',
            'chatApiUrl': 'getChatApiUrl', 'chatModel': 'getChatModel',
            'useSameAi': 'getUseSameAi', 'chatTrigger': 'getChatTrigger'
        };

        const levelDescriptions = [
            "【保守/长线】关注日线大趋势，极宽止损，分批挂单，极少操作。",
            "【稳健/趋势】关注1-4小时图，顺势而为，只做限价单回调，宁缺毋滥。",
            "【平衡/震荡】关注区间震荡，高抛低吸，可持有双向挂单(网格思维)。",
            "【激进/日内】关注15m-1h图，偶尔市价开单，止损较窄(<1%)，追求波段。",
            "【极激进/剥头皮】关注短期动能，频繁市价开单，极窄止损，快进快出。"
        ];

        function updateLevelDesc(val) {
            document.getElementById('levelValue').innerText = val;
            document.getElementById('levelDesc').innerText = levelDescriptions[val];
        }

        function showToast(msg) {
            var x = document.getElementById("toast");
            x.innerText = msg;
            x.className = "show";
            setTimeout(function(){ x.className = x.className.replace("show", ""); }, 2000);
        }

        function toggleChatConfig(checked) {
            document.getElementById('chatApiUrl').disabled = checked;
            document.getElementById('chatModel').disabled = checked;
            document.getElementById('chatConfigArea').style.opacity = checked ? '0.5' : '1';
        }

        // 初始化加载
        for (let id in map) {
            fetch(`/api/get_key/${map[id]}`)
                .then(r => r.json())
                .then(d => {
                    const el = document.getElementById(id);
                    if (el) {
                        if (el.type === 'checkbox') {
                            el.checked = (d.value === 'true');
                            if(id === 'useSameAi') toggleChatConfig(el.checked);
                        } else if (id === 'aggressionLevel') {
                            el.value = d.value || 2;
                            updateLevelDesc(el.value);
                        } else {
                            el.value = d.value;
                        }
                    }
                });
        }

        function saveVal(key, value) {
            if (key === 'tradeInterval' && (value === '' || parseInt(value) <= 0)) return;
            send(key, value);
        }
        function saveCheck(key, checked) {
            send(key, checked ? "true" : "false");
        }
        function send(key, value) {
            fetch('/api/set_key', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({key: key, value: value})
            })
            .then(r => r.json())
            .then(d => {
                if(d.status === 'ok') showToast("保存成功");
                else showToast("保存失败");
            });
        }
    </script>
</body>
</html>