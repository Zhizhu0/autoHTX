<!DOCTYPE html>
<html>
<head>
    <title>Configuration</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; background-color: #f9f9f9; }
        .group { margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #333; }
        input[type="text"], input[type="password"], input[type="number"] { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px; }
        .back { margin-bottom: 20px; display: inline-block; text-decoration: none; color: #007bff; font-weight: bold; }

        /* Toggle Switch */
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; -webkit-transition: .4s; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; -webkit-transition: .4s; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #2196F3; }
        input:focus + .slider { box-shadow: 0 0 1px #2196F3; }
        input:checked + .slider:before { -webkit-transform: translateX(26px); -ms-transform: translateX(26px); transform: translateX(26px); }
        .row { display: flex; align-items: center; justify-content: space-between; }
        .desc { font-size: 12px; color: #666; margin-top: 5px; }
        .vol-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
    </style>
</head>
<body>
    <a href="/" class="back">‚Üê Back to Home</a>
    <h2>System Configuration</h2>

    <!-- System Control -->
    <div class="group">
        <div class="row">
            <label style="margin:0">Enable Auto Trading</label>
            <label class="switch">
                <input type="checkbox" id="systemStatus" onchange="saveCheck('systemStatus', this.checked)">
                <span class="slider"></span>
            </label>
        </div>
        <div class="desc">Global master switch.</div>
    </div>

    <!-- Skip AI Check -->
    <div class="group">
        <div class="row">
            <label style="margin:0">Skip when Holding</label>
            <label class="switch">
                <input type="checkbox" id="skipWhenHolding" onchange="saveCheck('skipWhenHolding', this.checked)">
                <span class="slider"></span>
            </label>
        </div>
        <div class="desc">Skip AI analysis if positions are open.</div>
    </div>

    <!-- Ensure Valid Request (New) -->
    <div class="group">
        <div class="row">
            <label style="margin:0">Retry on Error</label>
            <label class="switch">
                <input type="checkbox" id="ensureValidReq" onchange="saveCheck('ensureValidReq', this.checked)">
                <span class="slider"></span>
            </label>
        </div>
        <div class="desc">If AI fails or returns invalid format, retry immediately (don't update schedule).</div>
    </div>

    <!-- Empty as None (New) -->
    <div class="group">
        <div class="row">
            <label style="margin:0">Treat Empty as No-Op</label>
            <label class="switch">
                <input type="checkbox" id="emptyAsNone" onchange="saveCheck('emptyAsNone', this.checked)">
                <span class="slider"></span>
            </label>
        </div>
        <div class="desc">If AI returns empty string, treat as "No Action" instead of error.</div>
    </div>

    <div class="group">
        <label>Trading Interval (Minutes)</label>
        <input type="number" id="tradeInterval" min="1" oninput="saveVal('tradeInterval', this.value)">
    </div>

    <div class="group">
        <label>Trading Symbol</label>
        <input type="text" id="tradeSymbol" oninput="saveVal('tradeSymbol', this.value)">
    </div>

    <div class="group">
        <label>Leverage</label>
        <input type="number" id="tradeLeverage" oninput="saveVal('tradeLeverage', this.value)">
    </div>

    <!-- Volume Settings -->
    <div class="group">
        <label>Open Volume (Contracts)</label>
        <div class="vol-grid">
            <div class="vol-item">
                <label>Lvl 0</label>
                <input type="number" id="volLevel0" oninput="saveVal('volLevel0', this.value)">
            </div>
            <div class="vol-item">
                <label>Lvl 1</label>
                <input type="number" id="volLevel1" oninput="saveVal('volLevel1', this.value)">
            </div>
            <div class="vol-item">
                <label>Lvl 2</label>
                <input type="number" id="volLevel2" oninput="saveVal('volLevel2', this.value)">
            </div>
            <div class="vol-item">
                <label>Lvl 3</label>
                <input type="number" id="volLevel3" oninput="saveVal('volLevel3', this.value)">
            </div>
        </div>
    </div>

    <!-- API Keys -->
    <h3>API Keys</h3>
    <div class="group">
        <label>Huobi Base URL</label>
        <input type="text" id="huobiUrl" oninput="saveVal('huobiUrl', this.value)">
    </div>
    <div class="group">
        <label>Gemini Key</label>
        <input type="password" id="geminiKey" oninput="saveVal('geminiKey', this.value)">
    </div>
    <div class="group">
        <label>Access Key</label>
        <input type="password" id="accessKey" oninput="saveVal('accessKey', this.value)">
    </div>
    <div class="group">
        <label>Secret Key</label>
        <input type="password" id="secretKey" oninput="saveVal('secretKey', this.value)">
    </div>

    <script>
        const map = {
            'geminiKey': 'getAIKey',
            'accessKey': 'getAccessKey',
            'secretKey': 'getSecretKey',
            'systemStatus': 'getSystemStatus',
            'skipWhenHolding': 'getSkipHolding',
            'ensureValidReq': 'getEnsureValid',
            'emptyAsNone': 'getEmptyAsNone',
            'tradeInterval': 'getInterval',
            'tradeSymbol': 'getSymbol',
            'tradeLeverage': 'getLeverage',
            'huobiUrl': 'getHuobiUrl',
            'volLevel0': 'getVol0',
            'volLevel1': 'getVol1',
            'volLevel2': 'getVol2',
            'volLevel3': 'getVol3'
        };

        for (let id in map) {
            fetch(`/api/get_key/${map[id]}`)
                .then(r => r.json())
                .then(d => {
                    const el = document.getElementById(id);
                    if (el) {
                        if (el.type === 'checkbox') {
                            el.checked = (d.value === 'true');
                        } else {
                            el.value = d.value;
                        }
                    }
                });
        }

        function saveVal(key, value) {
            if (key === 'tradeInterval' && (value === '' || parseInt(value) <= 0)) return;
            send(key, value);
        }
        function saveCheck(key, checked) {
            send(key, checked ? "true" : "false");
        }
        function send(key, value) {
            fetch('/api/set_key', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({key: key, value: value})
            });
        }
    </script>
</body>
</html>